"# Greylost\n\nThis sniffs DNS traffic and logs queries. It implements a time-based\nfilter to narrow the scope of DNS logs for analysts to examine; if\ntraffic to Google is typical for your environment, you won't be\ninnundated with these query logs, but WILL get logs for\nmalwaredomain123.xyz if that is an atypical query.\n\nThis can be installed locally, on a resolver/forwarder, or on a\nmachine plugged into a switchport that is mirroring ports.\n\n## Installation\n```\npip3 install -r requirements.txt\n```\n\n## Usage:\n```\nusage: greylost.py [-h] [--alllog ALLLOG] [--notdnslog NOTDNSLOG]\n                   [--greylistmisslog GREYLISTMISSLOG] [-b BPF] [-d]\n                   [--learningtime LEARNINGTIME] [--logging] [--ignore IGNORE]\n                   [-i INTERFACE] [-o] [-p PRECISION] [-r PIDFILE]\n                   [-s FILTERSIZE] [-t FILTERTIME] [-v] [-w DUMPFILE]\n\ngreylost by @dmfroberson\n\noptional arguments:\n  -h, --help            show this help message and exit\n  --alllog ALLLOG       /path/to/all-log -- log of all DNS queries\n  --notdnslog NOTDNSLOG\n                        /path/to/not-dns-log -- log of non-DNS protocol\n                        traffic\n  --greylistmisslog GREYLISTMISSLOG\n                        /path/to/greylist-miss-log -- log of greylist misses\n  -b BPF, --bpf BPF     BPF filter to apply to the sniffer\n  -d, --daemonize       Daemonize\n  --learningtime LEARNINGTIME\n                        Time to baseline queries before alerting on greylist\n                        misses\n  --logging             Toggle logging\n  --ignore IGNORE       File containing list of domains to ignore when\n                        greylisting\n  -i INTERFACE, --interface INTERFACE\n                        Interface to sniff\n  -o, --stdout          Toggle stdout output\n  -p PRECISION, --precision PRECISION\n                        Precision of bloom filter. Ex: 0.001\n  -r PIDFILE, --pidfile PIDFILE\n                        Path to PID file\n  -s FILTERSIZE, --filtersize FILTERSIZE\n                        Size of bloom filter\n  -t FILTERTIME, --filtertime FILTERTIME\n                        Filter time\n  -v, --verbose         increase verbosity\n  -w DUMPFILE, --dumpfile DUMPFILE\n                        Write captured packets to a dumpfile\n```\n\nExample:\n```\n./greylost.py -i eth0 --stdout --logging\n```\n\n## Splunk\nThe JSON logs provided by greylost can be indexed by Splunk.\n\n### Quickstart\nAdd indexes:\n```\ngreylost-all\ngreylost-misses\ngreylost-malware\n```\n\nAssuming you have Universal Forwarder installed and configured:\n```\nsplunk add monitor /path/to/greylost-all.log -index greylost-all\nsplunk add monitor /path/to/greylost-misses.log -index greylost-misses\nsplunk add monitor /path/to/greylost-malware.log -index greylost-malware\nsplunk add monitor /path/to/greylost-notdns.log -index greylost-notdns\n```\n\n### Searching\nNo dashboards or application exists (yet), but here are some queries\nI've found useful:\n\nSearch for resolutions of _malware.com_:\n```\nindex=greylost-all \"questions{}.qname\"=\"malware.com.\"\n```\n\nCounts of queries per host:\n```\nindex=greylost-misses | chart count by saddr\n```\n\nCounts of query types:\n```\nindex=greylost-misses |chart count by \"questions{}.qtype\"\n```\n\nHosts sending non-DNS traffic:\n```\nindex=greylost-notdns | chart count by saddr\n```\n\nHosts querying lots of TXT records:\n```\nindex=greylost-misses \"questions{}.qtype\"=TXT | chart count by saddr\n```"